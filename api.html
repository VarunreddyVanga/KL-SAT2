<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Live Geolocation Map with Data</title>
  <!-- Remove integrity attribute for simplicity (you can add it back if needed) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
</head>
<body>
  <div id="map" style="height: 400px;"></div>
  <div id="dataDisplay"></div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      function initMap() {
        const initialLatLng = [37.7749, -122.4194];
        const map = L.map('map').setView(initialLatLng, 12);

        // Add a TileLayer to the map
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        function updateMap(apiData) {
          if (apiData && apiData.entries && apiData.entries.length > 0) {
            const latestEntry = apiData.entries[0];
            const newLatLng = [parseFloat(latestEntry.lat), parseFloat(latestEntry.lng)];

            // Update map center and add a marker
            map.setView(newLatLng);

            // Clear existing markers (if any)
            if (map.markers) {
              map.markers.forEach(marker => marker.removeFrom(map));
            }

            // Add a new marker at the updated coordinates
            const marker = L.marker(newLatLng).addTo(map);
            map.markers = [marker];

            // Display data in the text area
            const dataDisplay = document.getElementById('dataDisplay');
            dataDisplay.innerHTML = `
              <p>Latitude: ${latestEntry.lat}</p>
              <p>Longitude: ${latestEntry.lng}</p>
              <p>Timestamp: ${latestEntry.timestamp}</p>
            `;
          }
        }

        function fetchData() {
          fetch('http://localhost:3000/api/data')
            .then(response => response.json())
            .then(data => {
              updateMap(data);
            })
            .catch(error => {
              console.error('Error fetching live data:', error);
            });
        }

        fetchData();

        // Schedule periodic updates (every 10 seconds in this example)
        setInterval(fetchData, 10000); // Fetch data every 10 seconds
      }

      initMap();
    });
  </script>
</body>
</html>
