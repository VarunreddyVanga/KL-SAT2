<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>KL SAT | ðŸ”´LIVE</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="live.css">
        <link rel="styelsheet" href="styleg.css">
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css">
        <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    </head>
    <body>
    <div id="container--main">
        <img src="images/KL.png" class="logo">
        <div class="line-break"></div>
        <section class="timer">
        <script src="https://cdn.logwork.com/widget/countdown.js"></script>
        <script src="https://cdn.logwork.com/widget/countdown.js"></script>
        <script src="https://cdn.logwork.com/widget/countdown.js"></script>
        <a href="https://logwork.com/countdown-timer" class="countdown-timer" data-style="flip3" data-timezone="Asia/Kolkata" data-textcolor="#2b2b2b" data-date="2024-03-08 18:40" data-background="#99ebff" data-digitscolor="#1a1a1a" data-unitscolor="#2e2e2e">Launch Timer</a>
        </section>
        <div id="frames">
        <section id="wrapper--hero" class="section--page">
            <iframe width="100%" height="350px" src="https://www.youtube.com/embed/HGl5n8NkRvs?si=-Vd67m5u8ToR2Ndy" title="YouTube video player" 
            frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
            allowfullscreen></iframe>
            <iframe width="100%" height="350px" src="https://www.youtube.com/embed/HGl5n8NkRvs?si=-Vd67m5u8ToR2Ndy" title="YouTube video player" 
            frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
            allowfullscreen></iframe>
        </section>
        <section id="wrapper--hero">
            <div id="map" style="width: 100%; height: 400px;"></div>
            <section id="wrapper--hero">
            <div id="dataDisplay" style="font-weight: 400;"></div></section>
        </section>
        <iframe width="100%" height="700px" src="" scrolling="0"></iframe>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
          let lastKnownLocation = {
            coordinates: [16.44225, 80.62420], // Default location
            timestamp: new Date().toLocaleString()
          };
    
          function initMap() {
            const map = L.map('map').setView(lastKnownLocation.coordinates, 12);
    
            // Add a TileLayer to the map
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);
    
            function updateMap(apiData) {
              if (apiData && apiData.entries && apiData.entries.length > 0) {
                const latestEntry = apiData.entries[0];
                const newLatLng = [parseFloat(latestEntry.lat), parseFloat(latestEntry.lng)];
    
                // Update map center and add a marker
                map.setView(newLatLng);
    
                // Clear existing markers (if any)
                if (map.markers) {
                  map.markers.forEach(marker => marker.removeFrom(map));
                }
    
                // Add a new marker at the updated coordinates
                const marker = L.marker(newLatLng).addTo(map);
                map.markers = [marker];
    
                // Update lastKnownLocation with timestamp
                lastKnownLocation = {
                  coordinates: newLatLng,
                  timestamp: new Date().toLocaleString()
                };
    
                // Display data in the text area
                const dataDisplay = document.getElementById('dataDisplay');
                dataDisplay.innerHTML = `
                  <p>Last Updated Location:</p>
                  <p>Latitude: ${lastKnownLocation.coordinates[0]}</p>
                  <p>Longitude: ${lastKnownLocation.coordinates[1]}</p>
                  <p>Last Updated: ${lastKnownLocation.timestamp}</p>
                `;
              }
            }
    
            function fetchData() {
              fetch('http://localhost:3000/api/data')
                .then(response => response.json())
                .then(data => {
                  updateMap(data);
                })
                .catch(error => {
                  console.error('Error fetching live data:', error);
    
                  // Display last known location and data if the server is offline
                  map.setView(lastKnownLocation.coordinates);
    
                  const dataDisplay = document.getElementById('dataDisplay');
                  dataDisplay.innerHTML = `
                    <p><strong>Geo Server from KL-Sat was OFFLINE</strong></p>
                    <p>Last Known Location:</p>
                    <p>Latitude: ${lastKnownLocation.coordinates[0]}</p>
                    <p>Longitude: ${lastKnownLocation.coordinates[1]}</p>
                    <p>Last Updated: ${lastKnownLocation.timestamp}</p>
                  `;
                });
            }
    
            fetchData();
    
            // Schedule periodic updates (every 10 seconds in this example)
            setInterval(fetchData, 10000); // Fetch data every 10 seconds
          }
    
          initMap();
        });
      </script>
</body>
</html>